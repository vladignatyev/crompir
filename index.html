<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof crompir == 'undefined') crompir = {};

        crompir.imgs = [];

        crompir.resizeImage = function (srcImg, params) {
            var srcImgWidth = srcImg.width;
            var srcImgHeight = srcImg.height;
            var newWidth = -1;
            var newHeight = -1;

            if (params['newWidth']) {
                newWidth = params['newWidth'];
                if (params['newHeight']) {
                    newHeight = params['newHeight'];
                } else {
                    newHeight = srcImgHeight / srcImgWidth * newWidth;
                }
            } else if (params['newHeight']) {
                newHeight = params['newHeight'];
                newWidth = srcImgWidth / srcImgHeight * newHeight;
            } else if (params['scale']) {
                newWidth = srcImgWidth * params['scale'];
                newHeight = srcImgHeight * params['scale'];
            } else {
                //fail with error
                throw "Improper call to crompir.resizeImage";
            }

            var canvasCopy = document.createElement("canvas");
            var ctx = canvasCopy.getContext("2d");
            canvasCopy.width = newWidth;
            canvasCopy.height = newHeight;
            ctx.drawImage(srcImg, 0,0, newWidth, newHeight);
//            var result = ctx.getImageData(0,0,newWidth, newHeight);
//            document.removeChild(canvasCopy);
            return [canvasCopy, ctx];
        };

        crompir.Loader = function () {
            var myFiles;
            var myImages = [];
            var fileLoadingCursor;

            function recursivelyLoad() {


                if (fileLoadingCursor >= myFiles.length) {
                    console.log(myImages);
                    console.log(myImages[0].width);
                    console.log(myImages[0].height);



                    for (var i = 0; i < myImages.length; i++) {

                        var img = crompir.resizeImage(myImages[i], {'newHeight': 200});
                        console.log(img);
                        $('body').append($(img[0]));
                    }
//                    $('.previewPane img').each(function(i,obj){
//                        $(obj).attr('height', '100px');
//                    });
                    return;
                }

                var file = myFiles[fileLoadingCursor];
                var fr = new FileReader();

                function onload() {
                    var image = new Image();
                    image.onload = function (event) {
                        myImages.push(image);
                        recursivelyLoad();
                    };
                    image.src = fr.result;
                }

                fr.onload = onload;
                fr.readAsDataURL(file);
                fileLoadingCursor += 1;
            }

            this.load = function (files) {
                myFiles = files;
                fileLoadingCursor = 0;
                recursivelyLoad();
            };

            return this;
        };

        crompir.init = function ($el) {
            var input = $el.find('input[name=file]');
            var previewsPanel = $el.find('.previewPane');

            input.bind('change', function (event) {
//                input.hide('fast');
                var files = event.target.files;
                var loader = new crompir.Loader();
                loader.load(files);
//
//                for (var i = 0; i < files.length; i++) {
//                    var file = files[i];
//                    var fr = new FileReader();
//                    function onload(){
//                        var image = new Image();
//                        image.onload = function(event){
////                            crompir.imgs.push(image);
//                           previewsPanel.append(event.target);
//                        };
//                        image.src = fr.result;
//                    }
//                    fr.onload = onload;
//                    fr.readAsDataURL(file);    // begin reading
//                }
            });
        };


        $(document).ready(function () {
            crompir.init($('#crompir'))
        });
    </script>
</head>
<body>

<div id="crompir">
    <input name="file" type="file" multiple/>

    <canvas class="previewPane" style="position: absolute; width: 100%; height: 100px;"></canvas>
</div>


</body>
</html>
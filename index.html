<!DOCTYPE html>
<html>
<head>
    <title>crompir alpha</title>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jszip.js"></script>
    <script src="./js/jszip-inflate.js"></script>

    <link rel="stylesheet" type="text/css" href="./css/ui.css" />
    <script src="./js/crompir.js"></script>
    <script src="./js/ui.js"></script>

    <script type="text/javascript">
        var productImages = [];
        var sourceImages = [];

        function saveImages() {
            var zip = new JSZip();

            //processing
            $('#status').html('Processing...');
            for (var k = 0; k < sourceImages.length; k++) {
                productImages.push(crompir.processing.resizeImage(sourceImages[k].image, {'newWidth':400.0}));
            }
            $('#status').html('');

            console.log(productImages);
            //generating archive
            for (var i = 0; i < productImages.length; i++) {
                var savable = new Image();
                savable.src = productImages[i].toDataURL('image/jpeg');
                zip.file("img"+(i+1)+".jpg", savable.src.substr(savable.src.indexOf(',')+1), {base64:true});
            }

            location.href="data:application/zip;base64," + zip.generate();
        }

        $(document).ready(function () {
            $('input[name=file]').bind('change', function(event){
                var loader = new crompir.PreviewLoader();
                $(loader).bind('progress', function(event, data){
                    createImage(data.preview);
                });
                $(loader).bind('complete', function(event, data){
                    sourceImages = data.result;
                    console.log('source Imags');
                    console.log(sourceImages);
                    $('#save').bind('click', function(){
                        saveImages();
                    });
                    $('#save').removeClass('_disabled');
                });
                loader.load(event.target.files);
                console.log(event.target.files);
            });
        });
        $('#save').click();
    </script>
</head>
<body>
<div id="status"></div>
<div class="menu">
    <input id="load_input" class="menu_item_load" name="file" type="file" multiple/>
    <span id="load" class="menu_item" onclick="$('#load_input').click()">Load</span>
    <span id="save" class="menu_item _disabled">Save</span>
    <span id="save" class="menu_item" onclick="alert('Need no Photoshop anymore.')">About</span>
</div>
<div class="toolbar">
    Правило массового ресайза (не работает)
    <select id="resize" style="width: 90%">
        <option value="width">Ширина</option>
        <option value="height">Высота</option>
        <option value="length">Наибольшая длина</option>
        <option value="file_size">Вес файла</option>
    </select>
    <input type="text" value="800" style="width: 90%">
    <div class="scale">
        Scale
        <span onclick="setScale(100)">small</span>
        <span onclick="setScale(150)">middle</span>
        <span onclick="setScale(200)">big</span>
    </div>
</div>
<div id="images" class="images"></div>

</body>
</html>